name: Sync Upstream Repository

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Backup workflows and custom files
        run: |
          echo "ğŸ’¾ å¤‡ä»½å·¥ä½œæµå’Œè‡ªå®šä¹‰æ–‡ä»¶..."
          mkdir -p /tmp/backup
          
          # å¤‡ä»½æ•´ä¸ª .github ç›®å½•
          if [ -d ".github" ]; then
            cp -r .github /tmp/backup/
            echo "âœ… å·²å¤‡ä»½ .github/"
            ls -la /tmp/backup/.github/workflows/ || true
          fi
          
          # å¤‡ä»½å…¶ä»–è‡ªå®šä¹‰æ–‡ä»¶
          PROTECTED_FILES=(
            "README.md"
            ".gitignore"
          )
          
          for file in "${PROTECTED_FILES[@]}"; do
            if [ -f "$file" ]; then
              cp "$file" "/tmp/backup/"
              echo "âœ… å·²å¤‡ä»½: $file"
            fi
          done

      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/0xdabiaoge/singbox-lite.git 2>/dev/null || true
          git fetch upstream main

      - name: Sync from upstream
        run: |
          echo "ğŸ”„ åŒæ­¥ä¸Šæ¸¸ä»“åº“æ‰€æœ‰å†…å®¹..."
          git reset --hard upstream/main
          echo "âœ… å·²é‡ç½®åˆ°ä¸Šæ¸¸ç‰ˆæœ¬"

      - name: Restore workflows and custom files
        run: |
          echo "â™»ï¸ æ¢å¤å·¥ä½œæµå’Œè‡ªå®šä¹‰æ–‡ä»¶..."
          
          # æ¢å¤ .github ç›®å½•
          if [ -d "/tmp/backup/.github" ]; then
            rm -rf .github
            cp -r /tmp/backup/.github .
            echo "âœ… å·²æ¢å¤ .github/"
            echo "ğŸ“‚ å·¥ä½œæµæ–‡ä»¶åˆ—è¡¨:"
            ls -la .github/workflows/ || true
          fi
          
          # æ¢å¤å…¶ä»–è‡ªå®šä¹‰æ–‡ä»¶
          PROTECTED_FILES=(
            "README.md"
            ".gitignore"
          )
          
          for file in "${PROTECTED_FILES[@]}"; do
            if [ -f "/tmp/backup/$file" ]; then
              cp "/tmp/backup/$file" .
              echo "âœ… å·²æ¢å¤: $file"
            fi
          done
          
          echo ""
          echo "ğŸ“‹ å½“å‰ç›®å½•å†…å®¹:"
          ls -la

      - name: Commit and push
        run: |
          echo "ğŸ“ å‡†å¤‡æäº¤..."
          
          # æ˜ç¡®æ·»åŠ  .github ç›®å½•å’Œæ‰€æœ‰æ–‡ä»¶
          git add -A
          git add .github -f
          
          echo "ğŸ“Š Git çŠ¶æ€:"
          git status
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ staged changes
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            echo "âœ… æ£€æµ‹åˆ°å˜åŒ–ï¼Œå‡†å¤‡æäº¤..."
            
            git commit -m "ğŸ”„ sync: update from upstream (ä¿æŠ¤å·¥ä½œæµ)
            
            - åŒæ­¥ä¸Šæ¸¸æ‰€æœ‰å†…å®¹
            - ä¿ç•™ .github/workflows/
            - ä¿ç•™è‡ªå®šä¹‰æ–‡ä»¶
            
            Sync time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            
            echo "ğŸš€ æ¨é€åˆ°è¿œç¨‹..."
            git push origin $(git branch --show-current)
            
            echo "âœ… åŒæ­¥æˆåŠŸï¼"
          fi

      - name: Verify workflow exists
        if: always()
        run: |
          echo "ğŸ” éªŒè¯å·¥ä½œæµæ–‡ä»¶..."
          if [ -d ".github/workflows" ]; then
            echo "âœ… .github/workflows/ ç›®å½•å­˜åœ¨"
            echo "ğŸ“‚ å·¥ä½œæµæ–‡ä»¶:"
            ls -la .github/workflows/
          else
            echo "âŒ è­¦å‘Š: .github/workflows/ ç›®å½•ä¸å­˜åœ¨ï¼"
          fi

      - name: Sync summary
        if: always()
        run: |
          echo "================================"
          echo "ğŸ“Š åŒæ­¥ä»»åŠ¡æ‘˜è¦"
          echo "================================"
          echo "ğŸ•’ æ‰§è¡Œæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— ä¸Šæ¸¸ä»“åº“: https://github.com/0xdabiaoge/singbox-lite"
          echo "ğŸ“ åŒæ­¥ç­–ç•¥: å®Œæ•´åŒæ­¥"
          echo "ğŸ›¡ï¸ å—ä¿æŠ¤å†…å®¹:"
          echo "   - .github/workflows/ (å·¥ä½œæµæ–‡ä»¶)"
          echo "   - README.md"
          echo "   - .gitignore"
          echo "================================"